{"version":3,"file":"index.umd.js","sources":["../src/version.ts","../src/UAuthConnector.ts"],"sourcesContent":["export const VERSION = \"2.4.0\";\n","import type UAuth from '@uauth/js'\nimport type {\n  LoginCallbackOptions,\n  UAuthConstructorOptions,\n  UserInfo,\n} from '@uauth/js'\nimport {AbstractConnector} from '@web3-react/abstract-connector'\nimport {\n  AbstractConnectorArguments,\n  ConnectorEvent,\n  ConnectorUpdate,\n} from '@web3-react/types'\nimport {VERSION} from './version'\n\nif (typeof window !== 'undefined') {\n  const _w = window as any\n  _w.UAUTH_VERSION = _w.UAUTH_VERSION || {}\n  _w.UAUTH_VERSION.WEB3_REACT = VERSION\n}\n\nexport interface UAuthConnectors {\n  injected: AbstractConnector\n  walletconnect: AbstractConnector\n}\n\nexport interface UAuthConnectorOptions\n  extends AbstractConnectorArguments,\n    Partial<UAuthConstructorOptions> {\n  uauth?: UAuth\n  connectors: UAuthConnectors\n  shouldLoginWithRedirect?: boolean\n}\n\nexport interface ConnectorLoginCallbackOptions {\n  url?: string\n  activate: (\n    connector: AbstractConnector,\n    onError?: (error: Error) => void,\n    throwErrors?: boolean,\n  ) => Promise<void>\n  onError?: (error: Error) => void\n  throwErrors?: boolean\n}\n\nclass UAuthConnector extends AbstractConnector {\n  static UAuth: typeof UAuth\n\n  static registerUAuth(pkg: typeof UAuth): void {\n    UAuthConnector.UAuth = pkg\n  }\n\n  public static async importUAuth(): Promise<void> {\n    if (UAuthConnector.UAuth == null) {\n      UAuthConnector.UAuth = (await import('@uauth/js').then(\n        m => m?.default ?? m,\n      )) as typeof UAuth\n    }\n  }\n\n  private _subConnector?: AbstractConnector\n  private _uauth?: UAuth\n\n  constructor(public options: UAuthConnectorOptions) {\n    super({supportedChainIds: options.supportedChainIds})\n  }\n\n  async callbackAndActivate<T>(\n    options: ConnectorLoginCallbackOptions,\n  ): Promise<void> {\n    await UAuthConnector.importUAuth()\n\n    const {activate, onError, throwErrors, ...callbackOptions} = options\n\n    if (callbackOptions.url) {\n      await this.uauth.loginCallback(callbackOptions as LoginCallbackOptions)\n    } else {\n      await this.uauth.loginCallback()\n    }\n\n    return activate(this, onError, throwErrors)\n  }\n\n  public async activate(): Promise<ConnectorUpdate> {\n    await UAuthConnector.importUAuth()\n\n    let user: UserInfo\n    try {\n      user = await this.uauth.user()\n    } catch (error) {\n      if (!this.uauth.fallbackLoginOptions.scope.includes('wallet')) {\n        throw new Error(\n          'Must request the \"wallet\" scope for connector to work.',\n        )\n      }\n\n      if (this.options.shouldLoginWithRedirect) {\n        await this.uauth.login({\n          packageName: '@uauth/web3-react',\n          packageVersion: VERSION,\n        })\n\n        // NOTE: We don't want to throw because the page will take some time to\n        // load the redirect page.\n        // eslint-disable-next-line @typescript-eslint/no-empty-function\n        await new Promise<void>(() => {})\n        // We need to throw here otherwise typescript won't know that user isn't null.\n        throw new Error('Should never get here.')\n      } else {\n        await this.uauth.loginWithPopup({\n          packageName: '@uauth/web3-react',\n          packageVersion: VERSION,\n        })\n        user = await this.uauth.user()\n      }\n    }\n\n    if (user.wallet_type_hint == null) {\n      throw new Error('no wallet type present')\n    }\n\n    if (['web3', 'injected'].includes(user.wallet_type_hint)) {\n      this._subConnector = this.options.connectors.injected\n    } else if (user.wallet_type_hint === 'walletconnect') {\n      this._subConnector = this.options.connectors.walletconnect\n    } else {\n      throw new Error('Connector not supported')\n    }\n\n    if ((this as any)?._subConnector?.on) {\n      this._subConnector.on(ConnectorEvent.Update, this.handleUpdate)\n      this._subConnector.on(ConnectorEvent.Deactivate, this.handleDeactivate)\n      this._subConnector.on(ConnectorEvent.Error, this.handleError)\n    }\n\n    const update = await this._subConnector!.activate()\n\n    return update\n  }\n\n  public deactivate(): void {\n    if (this._subConnector) {\n      if (!this.uauth.fallbackLogoutOptions.rpInitiatedLogout) {\n        this.uauth.logout({rpInitiatedLogout: false})\n      }\n\n      if ((this as any)?._subConnector?.removeListener) {\n        this._subConnector.removeListener(\n          ConnectorEvent.Update,\n          this.handleUpdate,\n        )\n        this._subConnector.removeListener(\n          ConnectorEvent.Deactivate,\n          this.handleDeactivate,\n        )\n        this._subConnector.removeListener(\n          ConnectorEvent.Error,\n          this.handleError,\n        )\n      }\n\n      this.uauth.logout()\n\n      this._subConnector.deactivate()\n    }\n  }\n\n  public async isAuthorized(): Promise<boolean> {\n    const user = await this.uauth.user()\n\n    if (!user || typeof this.subConnector?.isAuthorized !== 'function') {\n      return false\n    }\n\n    return this.subConnector.isAuthorized()\n  }\n\n  public getProvider(): Promise<any> {\n    return this.subConnector.getProvider()\n  }\n\n  public getChainId(): Promise<number | string> {\n    return this.subConnector.getChainId()\n  }\n\n  public getAccount(): Promise<null | string> {\n    return this.subConnector.getAccount()\n  }\n\n  public get uauth(): UAuth {\n    const {\n      supportedChainIds,\n      connectors,\n      uauth,\n      shouldLoginWithRedirect,\n      ...uauthOptions\n    } = this.options\n\n    if (uauth) {\n      return uauth\n    }\n\n    if (this._uauth) {\n      return this._uauth\n    }\n\n    if (UAuthConnector.UAuth == null) {\n      throw new Error('Must import UAuth before constructing a UAuth Object')\n    }\n\n    if (!uauthOptions.clientID || !uauthOptions.redirectUri) {\n      throw new Error('Incomplete constructor options')\n    }\n\n    this._uauth = new UAuthConnector.UAuth(\n      uauthOptions as UAuthConstructorOptions,\n    )\n\n    return this._uauth\n  }\n\n  public get subConnector(): AbstractConnector & {\n    isAuthorized?(): Promise<boolean>\n  } {\n    if (this._subConnector == null) {\n      throw new Error('no subconnector')\n    }\n\n    return this._subConnector\n  }\n\n  private handleUpdate = (update: ConnectorUpdate<string | number>) =>\n    this.emitUpdate(update)\n  private handleDeactivate = () => this.emitDeactivate()\n  private handleError = error => this.emitError(error)\n}\n\nexport default UAuthConnector\n"],"names":["VERSION","window","_w","UAUTH_VERSION","WEB3_REACT","UAuthConnector","registerUAuth","options","_this","_AbstractConnector","call","this","supportedChainIds","_subConnector","_uauth","handleUpdate","update","emitUpdate","handleDeactivate","emitDeactivate","handleError","error","emitError","pkg","UAuth","importUAuth","_temp2","Promise","resolve","import","then","m","_m$default","_import$then","callbackAndActivate","_this3","_temp4","activate","onError","throwErrors","callbackOptions","_objectWithoutPropertiesLoose","_excluded","_temp3","url","uauth","loginCallback","user","_temp6","_result","_this5$_subConnector","wallet_type_hint","Error","includes","_this5","connectors","injected","walletconnect","on","ConnectorEvent","Update","Deactivate","_temp5","_this4$uauth$user","_catch","fallbackLoginOptions","scope","shouldLoginWithRedirect","login","packageName","packageVersion","loginWithPopup","deactivate","_this$_subConnector","fallbackLogoutOptions","rpInitiatedLogout","logout","removeListener","isAuthorized","_this7","_this7$subConnector","subConnector","getProvider","getChainId","getAccount","uauthOptions","_this$options","_excluded2","clientID","redirectUri","AbstractConnector"],"mappings":"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"}